<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Per-Segment Speed Demo</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .legend {
      position: absolute; top: 12px; right: 12px; z-index: 1;
      background: rgba(255,255,255,0.92); border-radius: 8px;
      padding: 10px 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font: 13px/1.3 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color: #222;
    }
    .legend .title { font-weight: 600; margin-bottom: 6px; }
    .legend .row { display: flex; align-items: center; margin: 4px 0; }
    .legend .swatch { width: 18px; height: 10px; border-radius: 2px; margin-right: 8px; }
    .legend .note { margin-top: 6px; font-size: 12px; color: #555; }
  </style>
</head>
<body>
<div id="map"></div>

<div class="legend">
  <div class="title">Speed (km/h)</div>
  <div class="row"><span class="swatch" style="background:#4575b4;"></span><span>0–10</span></div>
  <div class="row"><span class="swatch" style="background:#91bfdb;"></span><span>10–20</span></div>
  <div class="row"><span class="swatch" style="background:#e0f3f8;"></span><span>20–25</span></div>
  <div class="row"><span class="swatch" style="background:#ffffbf;"></span><span>25–30</span></div>
  <div class="row"><span class="swatch" style="background:#fee090;"></span><span>30–35</span></div>
  <div class="row"><span class="swatch" style="background:#fc8d59;"></span><span>35–40</span></div>
  <div class="row"><span class="swatch" style="background:#d73027;"></span><span>40+</span></div>
  <div class="note">Each line segment uses its own <code>Speed GPS</code> value.</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoidG9tdmFuYXJtYW4iLCJhIjoiRDlFeWFVdyJ9.B6ZgpP0CsDlAF1D1emvosg';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/dark-v11',
  center: [4.895, 52.37],
  zoom: 12
});

map.on('load', async () => {
  try {
    // Load the per-segment GeoJSON (created earlier)
    const resp = await fetch('track_segments_with_speed.geojson');
    const data = await resp.json();

    map.addSource('ride-segments', { type: 'geojson', data });

    map.addLayer({
      id: 'ride-colored-by-speed',
      type: 'line',
      source: 'ride-segments',
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: {
        'line-width': 4,
        'line-color': [
          'interpolate', ['linear'], ['coalesce', ['get', 'Speed GPS'], 0],
          0,'#4575b4',
          10,'#91bfdb',
          20,'#e0f3f8',
          25,'#ffffbf',
          30,'#fee090',
          35,'#fc8d59',
          40,'#d73027'
        ]
      }
    });

    // Fit to data bounds
    const bounds = new mapboxgl.LngLatBounds();
    (data.features || []).forEach(f => {
      if (!f || !f.geometry) return;
      if (f.geometry.type === 'LineString') {
        (f.geometry.coordinates || []).forEach(c => bounds.extend(c));
      } else if (f.geometry.type === 'MultiLineString') {
        (f.geometry.coordinates || []).forEach(line => (line || []).forEach(c => bounds.extend(c)));
      }
    });
    if (!bounds.isEmpty()) map.fitBounds(bounds, { padding: 40, maxZoom: 16 });
  } catch (e) {
    console.error('Failed to load per-segment data', e);
  }
});
</script>
  <script>
// single popup reused for performance
const hoverPopup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false,
  offset: 12,
  className: 'speed-hover'
});

// show tooltip on hover
map.on('mousemove', 'ride-colored-by-speed', (e) => {
  const f = e.features && e.features[0];
  if (!f) return;

  // read speed from your properties; fall back names just in case
  const raw =
    f.properties['Speed GPS'] ??
    f.properties['speed_kmh'] ??
    f.properties['speed'] ??
    null;

  const speed =
    raw == null || isNaN(Number(raw)) ? null : Number(raw);

  const html = speed == null
    ? `<div style="font:13px sans-serif;">Speed: n/a</div>`
    : `<div style="font:13px sans-serif;">
         <strong>${speed.toFixed(1)}</strong> km/h
       </div>`;

  hoverPopup
    .setLngLat(e.lngLat)
    .setHTML(html)
    .addTo(map);

  map.getCanvas().style.cursor = 'pointer';
});

// hide tooltip when leaving the layer
map.on('mouseleave', 'ride-colored-by-speed', () => {
  hoverPopup.remove();
  map.getCanvas().style.cursor = '';
});
</script>
</body>
</html>
